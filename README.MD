# –ú–µ—Ç–æ–¥–∏—á–∫–∞ –ø–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é PostgreSQL –≤ Docker Compose –≤ —Ä–µ–∂–∏–º–µ SSL –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∫ –Ω–µ–π —Å –ø–æ–º–æ—â—å—é —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.

## 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ `Docker`, `Docker Compose` –∏ `OpenSSL`

### 1.1 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç Docker](https://www.docker.com/products/docker-desktop) –∏ —Å–∫–∞—á–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–ª—è –≤–∞—à–µ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker, —Å–ª–µ–¥—É—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ.

### 1.2 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OpenSSL:
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
```bash
apt install openssl
```

### 1.3 –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É:
   - –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `Docker` –∏ `Docker Compose` –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã:
```bash
docker --version
docker-compose --version
```
   - –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `OpenSSL` –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:
```bash
openssl help
```

---
## 2: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

### 2.1 –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
```bash
git clone https://github.com/SBRDIGITAL/postgrocker_ssl.git
```

## 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### 3.1 –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –≥–¥–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

```bash
cd ./certs
```

### 3.2 –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ CA

```bash
# –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è CA
openssl genpkey -algorithm RSA -out ca.key -pkeyopt rsa_keygen_bits:4096

# –°–æ–∑–¥–∞—ë–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç CA
openssl req -new -x509 -days 3650 -key ca.key -out ca.pem -subj "/C=US/ST=State/L=City/O=Organization/OU=Unit/CN=MyCA"
```

### 3.3 –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
**–î–ª—è `CN=localhost` —É–∫–∞–∂–∏—Ç–µ ip –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ë–î –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ `localhost`** 
```bash
# –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞
openssl genpkey -algorithm RSA -out server.key -pkeyopt rsa_keygen_bits:2048

# –°–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–ø–∏—Å—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl req -new -key server.key -out server.csr -subj "/C=US/ST=State/L=City/O=Organization/OU=Unit/CN=localhost"

# –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º CSR —Å –ø–æ–º–æ—â—å—é CA
openssl x509 -req -in server.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out server.pem -days 365 -sha256
```

### 3.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
openssl x509 -in server.pem -noout -issuer -subject

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl verify -CAfile ca.pem server.pem
```

–î–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å—Å—è —á—Ç–æ-—Ç–æ –Ω–∞ –ø–æ–¥–æ–±–∏–∏:
```bash
issuer=C = US, ST = State, L = City, O = Organization, OU = Unit, CN = MyCA
subject=C = US, ST = State, L = City, O = Organization, OU = Unit, CN = 1.2.3.4
server.pem: OK
```
### 3.5 –í—ã—Ö–æ–¥–∏–º –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏

```bash
cd ..
```
## 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PostgreSQL –≤ Docker Compose

### 4.1 –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º `docker-compose.yml`

```yaml
services:
  postgres:
    image: postgres:latest
    container_name: postgres_tls
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: mydatabase
    volumes:
      - ./data/db:/var/lib/postgresql/data
      - ./certs:/etc/ssl/postgres
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf
    networks:
      - postgres-cluster
    command: [
      "postgres",
      "-c", "ssl=on",
      "-c", "ssl_cert_file=/etc/ssl/postgres/server.pem",
      "-c", "ssl_key_file=/etc/ssl/postgres/server.key",
      "-c", "ssl_ca_file=/etc/ssl/postgres/ca.pem"
    ]

volumes:
  postgres_data:

networks:
  postgres-cluster:
```

### 4.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `pg_hba.conf`

–°–æ–∑–¥–∞–π—Ç–µ `pg_hba.conf` —Ä—è–¥–æ–º —Å `docker-compose.yml` –∏ –¥–æ–±–∞–≤—å—Ç–µ:

```conf
# –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ SSL
hostssl all all 0.0.0.0/0 cert clientcert=verify-full
```
–∏–ª–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
```bash
# –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±–µ–∑ –ø–∞—Ä–æ–ª—è
local all all trust

# –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ SSL —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞
hostssl all all 0.0.0.0/0 cert clientcert=verify-full

# –í–Ω–µ—à–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ SSL —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–∞—Ä–æ–ª—è
hostssl all all 0.0.0.0/0 md5

# –í–Ω–µ—à–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ SSL —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (SCRAM)
hostssl all all 0.0.0.0/0 scram-sha-256
```
## 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –Ω–∞ —Ñ–∞–π–ª—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

```bash
chmod 600 ./certs/server.key
chmod 644 ./certs/server.pem ./certs/ca.pem
chown 999:999 ./certs/server.key ./certs/server.pem ./certs/ca.pem
```

## 6. –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```bash
docker-compose up -d
```

## 7. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —á–µ—Ä–µ–∑ pgAdmin 4

### 7.1 –°–∫–∞—á–∞–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç –≤ —É–¥–æ–±–Ω—É—é –¥–ª—è –≤–∞—Å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –ø—É—Ç—è—Ö –∫–∏—Ä–∏–ª–ª–∏—Ü—É!!!`
### 7.2 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ `pgAdmin4`
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä (`New Server`).
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É **Connection**:
    - **Host name/address**: `217.114.13.80`
    - **Port**: `5432`
    - **Maintenance database**: `mydatabase`
    - **Username**: `admin`
    - **Password**: –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º (–µ—Å–ª–∏ `clientcert=verify-full`)
    - **SSL Mode**: `verify-full`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É **SSL** –∏ —É–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª—ã:
    - **Root Certificate**: `ca.pem`
    - **Client Certificate**: `server.pem`
    - **Client Key**: `server.key`
    - **SSL Mode**: `verify-full`
4. –ù–∞–∂–º–∏—Ç–µ **Save** –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.
5. –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–æ–ª—å –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑–∞–Ω –≤ `environment: POSTGRES_PASSWORD:` –≤–Ω—É—Ç—Ä–∏ `docker-compose.yml`

## 8. –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
### üîπ –û—à–∏–±–∫–∞ `CN mismatch`
**–ü—Ä–æ–±–ª–µ–º–∞**: PostgreSQL –æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ `CN` –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`admin`).
**–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å `CN=admin` –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å `clientcert=verify-full` –≤ `pg_hba.conf`.

### üîπ –û—à–∏–±–∫–∞ `certificate signature failure`
**–ü—Ä–æ–±–ª–µ–º–∞**: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç `server.pem` –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–µ —Ç–µ–º CA.
**–†–µ—à–µ–Ω–∏–µ**: –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–¥–ø–∏—à–∏—Ç–µ `server.pem` —Å –ø–æ–º–æ—â—å—é `ca.pem`.

### üîπ –û—à–∏–±–∫–∞ `could not load private key`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É `server.key`.
**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
```bash
chmod 600 ./certs/server.key
chown 999:999 ./certs/server.key
```

## 9. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
### 9.1 –§–∞–π–ª `certs\__init__.py` –Ω—É–∂–µ–Ω –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–∏—Ç–æ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `certs`. –û–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
## –ì–æ—Ç–æ–≤–æ! `PostgreSQL` —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ SSL-—Ä–µ–∂–∏–º–µ üöÄ
